(()=>{"use strict";var t;!function(t){function e(){globalThis.String.prototype.stripTags=function(){return this.replace(/(\<(\/?[^>]+)>)/g,"")},globalThis.String.prototype.htmlspecialchars=function(t=!1){let e=this.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");return t?e.replaceAll('"',"&quot;").replaceAll("'","&apos;"):e}}function o(){globalThis.Array.prototype.shuffle=function(){return this.sort((()=>Math.random()-.5))},globalThis.Array.prototype.randomElements=function(t=1,e=!1){let o=[],r=this.slice();for(let i=0;i<t&&(0!=r.length||!e);i++){let t=Math.floor(Math.random()*r.length),i=r[t];e&&r.splice(t,1),o.push(i)}return 1==t?o[0]:o}}t.All=function(){e(),o()},t.String=e,t.Array=o}(t||(t={})),t.Array();const e=document.querySelector("#c"),o=e.getContext("2d");var r;!function(t){function e(){t.targetTetramino&&(clearInterval(t.targetTetramino.fallInterval),t.targetTetramino.createBlocks().forEach(t.allBlock.add.bind(t.allBlock)))}t.width=15,t.height=20,t.allBlock=new Set,t.targetTetramino=null,t.clearTarget=e,t.newTarget=function(){e(),t.targetTetramino=f.randomElements().clone(),t.targetTetramino.fallLoop(),t.targetTetramino.pos.x+=Math.floor(t.width/2)-1,t.targetTetramino.checkCollisionWithBlock()&&(e(),h()),t.checkLines()},t.checkLines=function(){let e=[...t.allBlock],o=0;for(let r=0;r<t.height;r++){let i=e.filter((t=>t.pos.y==r));i.length==t.width&&(o++,i.filter(t.allBlock.delete.bind(t.allBlock)),e.filter((t=>t.pos.y<r)).forEach((t=>t.pos.y++)))}o<1||(s.dropInter=Math.max(s.dropInter-10,50),1==o&&(s.score+=100),2==o&&(s.score+=300),3==o&&(s.score+=700),o>=4&&(s.score+=1500))}}(r||(r={}));const i=()=>Math.min(innerHeight,innerWidth)/Math.min(r.height,r.width)/1.5;var n,l,s,a,c;function h(){alert("GAMEOVER");let t=+String(localStorage.getItem("bestScore"));localStorage.setItem("bestScore",String(Math.max(s.score,isNaN(t)?0:t))),n.stop(),r.clearTarget()}window.addEventListener("resize",function t(){let o=i();return e.width=r.width*o,e.height=r.height*o+o,t}()),function(t){function e(t){s.timeWithStart=t/1e3,l.Clear(),l.Blocks(),a.display(),o=requestAnimationFrame(e)}let o;t.start=function(){s.reset(),o=requestAnimationFrame(e),document.addEventListener("keydown",d),r.newTarget()},t.stop=function(){cancelAnimationFrame(o),document.removeEventListener("keydown",d)}}(n||(n={})),function(t){t.Clear=function(){o.clearRect(0,0,e.width,e.height)},t.Blocks=function(){let t=[...r.allBlock];r.targetTetramino&&t.push(r.targetTetramino);for(let e of t){if(!e)return;const t=i();function r(r,i){o.rect(e.pos.x*t+r*t,e.pos.y*t+i*t+t,t,t)}if(o.beginPath(),e instanceof m)for(let t=0;t<e.struct[e.rotateIndex].length;t++)for(let o=0;o<e.struct[e.rotateIndex][t].length;o++)e.struct[e.rotateIndex][t][o]&&r(o,t);else r(0,0);o.fillStyle=e.color,o.fill(),o.stroke(),o.closePath()}}}(l||(l={})),function(t){t.reset=function(){t.score=0,t.timeWithStart=0,t.dropInter=1e3};let e=+String(localStorage.getItem("bestScore"));t.bestScore=isNaN(e)?0:e}(s||(s={})),function(t){let e=document.querySelector("#score > span"),o=document.querySelector("#bestScore > span"),r=document.querySelector("#time > span");t.display=function(){e.textContent=String(s.score),o.textContent=String(s.bestScore),r.textContent=String((()=>{let t=(s.timeWithStart%60).toFixed(0);return`${Math.floor(s.timeWithStart/60).toFixed(0)}:${t.length>1?t:`0${t}`}`})())}}(a||(a={})),function(t){t[t.Null=0]="Null",t[t.LWall=1]="LWall",t[t.RWall=2]="RWall",t[t.Floor=3]="Floor",t[t.Block=4]="Block"}(c||(c={}));class u{tetramino;pos;color;constructor(t,e,o){this.tetramino=t,this.pos=e,this.color=o}}class m{static accessColors=["red","yellow","blue","green"];color=m.accessColors.randomElements();createBlocks(){let t=[];return this.structForEach(((e,o,r)=>t.push(new u(this,{x:r+this.pos.x,y:o+this.pos.y},this.color)))),t}struct;rotateIndex=0;constructor(t){this.struct=t;let e=0;this.structForEach(((t,o,r)=>{e||(e=o)})),this.pos.y-=e,this.tmp=Math.random()}tmp;pos={y:0,x:0};clone(){return new m(this.struct)}structForEach(t){for(let e=0;e<this.struct[this.rotateIndex].length;e++)for(let o=0;o<this.struct[this.rotateIndex][e].length;o++){let r=this.struct[this.rotateIndex][e][o];1==r&&t(r,e,o)}}checkCollisionWithBlock(){for(let t=0;t<this.struct[this.rotateIndex].length;t++)for(let e=0;e<this.struct[this.rotateIndex][t].length;e++){if(!this.struct[this.rotateIndex][t][e])continue;let o=this.pos.x+e,i=this.pos.y+t;if(o<0)return c.LWall;if(o>r.width-1)return c.RWall;if(i>r.height-1)return c.Floor;for(let t of r.allBlock)if(t.pos.x==o&&t.pos.y==i)return c.Block}return c.Null}rotateL(t=!0){if(this.rotateIndex=(this.rotateIndex-=1)<0?this.struct.length-1:this.rotateIndex,t)switch(this.checkCollisionWithBlock()){case c.LWall:this.moveR(this.rotateR.bind(this));break;case c.RWall:this.moveL(this.rotateR.bind(this));break;case c.Block:this.rotateR()}}rotateR(t=!0){if(this.rotateIndex=(this.rotateIndex+1)%this.struct.length,t)switch(this.checkCollisionWithBlock()){case c.LWall:this.moveR(this.rotateL.bind(this));break;case c.RWall:this.moveL(this.rotateL.bind(this));break;case c.Block:this.rotateL()}}moveT(){this.pos.y--}moveB(){return this.pos.y++,!this.checkCollisionWithBlock()||(this.moveT(),r.newTarget(),!1)}moveL(t){this.pos.x--,this.checkCollisionWithBlock()&&(t&&t(!1),this.moveR())}moveR(t){this.pos.x++,this.checkCollisionWithBlock()&&(t&&t(!1),this.moveL())}fallInterval;fallLoop(){return this.fallInterval=setInterval(this.moveB.bind(this),s.dropInter),this}}const f=[new m([[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],[[0,0,1,0],[0,0,1,0],[0,0,1,0],[0,0,1,0]],[[0,0,0,0],[0,0,0,0],[1,1,1,1],[0,0,0,0]],[[0,1,0,0],[0,1,0,0],[0,1,0,0],[0,1,0,0]]]),new m([[[1,0,0],[1,1,1],[0,0,0]],[[0,1,1],[0,1,0],[0,1,0]],[[0,0,0],[1,1,1],[0,0,1]],[[0,1,0],[0,1,0],[1,1,0]]]),new m([[[0,0,1],[1,1,1],[0,0,0]],[[0,1,0],[0,1,0],[0,1,1]],[[0,0,0],[1,1,1],[1,0,0]],[[1,1,0],[0,1,0],[0,1,0]]]),new m([[[1,1],[1,1]],[[1,1],[1,1]],[[1,1],[1,1]],[[1,1],[1,1]]]),new m([[[0,1,1],[1,1,0],[0,0,0]],[[0,1,0],[0,1,1],[0,0,1]],[[0,0,0],[0,1,1],[1,1,0]],[[1,0,0],[1,1,0],[0,1,0]]]),new m([[[0,1,0],[1,1,1],[0,0,0]],[[0,1,0],[0,1,1],[0,1,0]],[[0,0,0],[1,1,1],[0,1,0]],[[0,1,0],[1,1,0],[0,1,0]]]),new m([[[1,1,0],[0,1,1],[0,0,0]],[[0,0,1],[0,1,1],[0,1,0]],[[0,0,0],[1,1,0],[0,1,1]],[[0,1,0],[1,1,0],[1,0,0]]])];function d(t){switch(t.code){case"KeyE":r.targetTetramino?.rotateR();break;case"KeyQ":r.targetTetramino?.rotateL();break;case"KeyA":r.targetTetramino?.moveL();break;case"KeyD":r.targetTetramino?.moveR();break;case"KeyS":r.targetTetramino?.moveB()}}n.start()})();